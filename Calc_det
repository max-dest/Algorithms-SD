#include <stdio.h>
#include <stdlib.h>



////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////HEAD//////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

typedef struct matrich smt;


smt * smt_make(int * size);

smt * smt_read(void);

void smt_del(smt * _smt);

double smt_det_calc(smt * _smt);

void swap_lines(smt * _smt, int * ln_1, int * ln_2);

void multiply_line(smt * _smt, int * ln, double k);

void deduction_line(smt * _smt, int * ln_1, int * ln_2, double k);

int get_com(void);

void help(void);

void life_meaning(void);



////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////MAIN//////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

int main(void) {
    int flag = 0;
    smt * _stm = NULL;
    do {
        switch (get_com()) {
            case 1:
                _stm = smt_read();
                printf("det = %lf\n", smt_det_calc(_stm));
                smt_del(_stm);
                _stm = NULL;
                break;
            case 9:
                help();
                break;
            case 42:
                life_meaning();
                break;
            case 0:
                printf("Bye-bye!");
                flag = 1;
                break;
            case -1:
                printf("Error. Command not found.\n");
                break;
        }
    } while(flag == 0);


    return 0;
}



////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////FUNCTIONS///////////////////////////////////
////////////////////////////////////////////////////////////////////////////////

typedef struct matrich
{
    int size;
    double ** mt;
}smt;


smt * smt_make(int * size) {
    smt * _smt = (smt *) malloc(sizeof(smt));
    if (_smt == NULL) return NULL;
    _smt -> size = * size;
    _smt -> mt = (double **) malloc(* size * sizeof(double *));
    if (_smt -> mt == NULL) { free(_smt); return NULL; }
    int i = -1;
    do { i++; _smt -> mt[i] = (double *) malloc(* size * sizeof(double)); }
    while (i < * size && _smt -> mt[i] != NULL);
    for (i = 0; i < * size && _smt -> mt[i] == NULL; i++) 
    if (_smt -> mt[i] == NULL) {
        for (i--; i <= 0; i--) free(_smt -> mt[i]);
        free(_smt -> mt);
        free(_smt);
    }

    return _smt;
}


smt * smt_read(void) {
    int size;
    scanf("%d", & size);
    smt * _smt = smt_make(& size);
    if (_smt == NULL) return NULL;
    for (int i = 0; i < size; i++)
        for (int j = 0; j < size; j++) {
            scanf("%lf", & (_smt -> mt[i][j]));
        }

    return _smt;
}


void smt_del(smt * _smt) {
    for (int i = 0; i < _smt -> size; i++) free(_smt -> mt[i]);
    free(_smt -> mt);
    free(_smt);

    return;
}


double smt_det_calc(smt * _smt) {
    double det = 1.0;
    int j;

    for (int i = 0; i < _smt -> size; i++) {
        j = i;
        while (_smt -> mt[j][i] == 0 && j < _smt -> size) j++;
        if (_smt -> mt[j][i] == 0) return 0.0;
        if (i != j) { det *= -1.0; swap_lines(_smt, & i, & j); }
        det *= _smt -> mt[i][i];
        multiply_line(_smt, & i, 1.0 / _smt -> mt[i][i]);
        for (j = i + 1; j < _smt -> size; j++) deduction_line(_smt, & i, & j, _smt -> mt[j][i]);
    }

    return det;
}


void swap_lines(smt * _smt, int * ln_1, int * ln_2) {
    double * ln = _smt -> mt[* ln_1];
    _smt -> mt[* ln_1] = _smt -> mt[* ln_2];
    _smt -> mt[* ln_2] = ln;

    return;
}


void multiply_line(smt * _smt, int * ln, double k) {
    for (int i = 0; i < _smt -> size; i++) _smt -> mt[* ln][i] *= k;

    return;
}


void deduction_line(smt * _smt, int * ln_1, int * ln_2, double k) {
    for (int i = 0; i < _smt -> size; i++) _smt -> mt[* ln_2][i] -= k * _smt -> mt[* ln_1][i];

    return;
}


int get_com(void) {
    int count;
    char str[5]; str[4] = '\n';

    char st_det[3] = "det";
    char st_help[4] = "help";
    char st_42[2] = "42";
    char st_end[3] = "end";

    printf(">>");
    scanf("%s", str);

    count = 0;
    for (int i = 0; i < sizeof(st_det) / sizeof(char); i++)
        if (str[i] == st_det[i])
                count++;
    if (count == sizeof(st_det) / sizeof(char)) return 1;

    count = 0;
    for (int i = 0; i < sizeof(st_help) / sizeof(char); i++)
        if (str[i] == st_help[i])
                count++;
    if (count == sizeof(st_help) / sizeof(char)) return 9;

    count = 0;
    for (int i = 0; i < sizeof(st_42) / sizeof(char); i++)
        if (str[i] == st_42[i])
                count++;
    if (count == sizeof(st_42) / sizeof(char)) return 42;

    count = 0;
    for (int i = 0; i < sizeof(st_end) / sizeof(char); i++)
        if (str[i] == st_end[i])
                count++;
    if (count == sizeof(st_end) / sizeof(char)) return 0;

    return -1;
}


void help(void) {
    printf("Help:\n");
    printf("help - brings up a list of commands and their description.\n");
    printf("det - calculates the determinant of a square matrix.\n");
    printf("After typing the command, enter the matrix size as a single number, next, enter the matrix itself as an n*n number in the format decimal point separated.\n");
    printf("Example:\n");
    printf("3\n");
    printf("0.0 2.1 3.0\n");
    printf("1.4 4.5 2.0\n");
    printf("5.9 2.0 4.2\n");
    printf("end - end program execution\n");
        
    return;
}


void life_meaning(void) {
    printf("Yeah, yeah. \n42 is the meaning of life!\n");

    return;
}



////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////HELP//////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
//Все, мне стало лень писать хелп к функциям....
//если есть вопросы так спросите плиз, а я спатки
//кофе кончился
























